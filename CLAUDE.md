# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 🔨 最重要ルール - 新しいルールの追加プロセス

ユーザーから今回限りではなく常に対応が必要だと思われる指示を受けた場合：

1. 「これを標準のルールにしますか？」と質問する
2. YESの回答を得た場合、CLAUDE.mdに追加ルールとして記載する
3. 以降は標準ルールとして常に適用する

## 重要ルール

このプロジェクトではドキュメント、返信などはすべて日本語で行います

## プロジェクト概要

タワーディフェンスゲーム - 戦略的多様タワーシステム
- 技術スタック：TypeScript + PixiJS + Vite
- **現在の状況**: 5種類タワータイプ・高性能最適化システム完成
- **主要機能**: 
  - 1000発同時ミサイル処理対応
  - 空間分割衝突判定（80%+最適化）
  - 描画バッチング（自動Graphics→Sprite変換）
  - 戦略的ターゲティング（7種類）
  - リアルタイム統計追跡システム
- **次のステップ**: ウェーブシステム・アップグレードUI・経済システム

## プロジェクト構造

```
src/
  ├── game/                      # ゲームコア
  │   ├── Game.ts               # メインゲームクラス
  │   └── GameState.ts          # ゲーム状態管理
  ├── entities/                  # エンティティシステム
  │   ├── Entity.ts             # 基本エンティティクラス
  │   ├── components/           # ECSコンポーネント
  │   │   ├── Transform.ts      # 位置・回転・スケール
  │   │   ├── Velocity.ts       # 速度・移動
  │   │   ├── Health.ts         # HP管理
  │   │   ├── Weapon.ts         # 武器システム
  │   │   ├── Targeting.ts      # 高度ターゲット選択（7戦略対応）
  │   │   ├── Tower.ts          # タワー管理（統計・アップグレード）
  │   │   ├── MissileController.ts # ミサイル制御
  │   │   ├── PathFollower.ts   # パス追従
  │   │   └── Renderable.ts     # 高度描画管理（最適化対応）
  │   ├── types/                # タイプ定義
  │   │   └── TowerTypes.ts     # 5種類タワータイプ設定
  │   └── factories/            # エンティティ生成
  │       └── EntityFactory.ts  # マルチタイプ対応ファクトリー
  ├── systems/                   # ゲームシステム
  │   ├── EntityManager.ts      # エンティティ管理
  │   ├── GameSystem.ts         # ゲームロジック統合
  │   ├── CollisionSystem.ts    # 空間分割による高速衝突判定
  │   ├── RenderSystem.ts       # 高度描画システム（バッチ最適化対応）
  │   ├── PhysicsSystem.ts      # 物理演算システム
  │   └── InputSystem.ts        # 入力処理システム
  ├── rendering/                 # 描画最適化システム
  │   ├── BatchRenderer.ts      # Graphics→Sprite変換バッチ最適化
  │   └── PerformanceMonitor.ts # FPS・メモリ監視システム
  ├── utils/                     # ユーティリティ関数
  │   ├── pools/                # オブジェクトプール
  │   │   ├── ObjectPool.ts     # 汎用プールシステム
  │   │   ├── PoolableEntity.ts # プール対応エンティティ
  │   │   ├── MissilePool.ts    # ミサイル専用プール
  │   │   └── PoolManager.ts    # プール統合管理
  │   └── spatial/              # 空間分割システム
  │       └── SpatialHash.ts    # 空間ハッシュ実装
  ├── ui/                        # ユーザーインターフェース
  │   ├── DebugUIManager.ts     # リアルタイムデバッグGUI
  │   └── debug-ui.css          # モダンダークテーマスタイル
  ├── effects/                   # 視覚エフェクト
  │   ├── Particle.ts           # 単一パーティクル（火花、破片、煙）
  │   └── ParticleSystem.ts     # パーティクル管理とエフェクト生成
  └── main.ts                   # エントリーポイント
```

## 開発コマンド

- `npm install` - 依存関係のインストール
- `npm run dev` - 開発サーバー起動（localhost:3000）
- `npm run build` - プロダクションビルド
- `npm run preview` - ビルド後のプレビュー
- `npm run lint` - ESLintによるコード品質チェック
- `npm run lint:fix` - ESLintによる自動修正
- `npm run type-check` - TypeScriptの型チェックのみ実行

## 開発の流れ

1. 機能の追加、修正
2. テストの実施
3. gitを更新
4. githubにコミット

## アーキテクチャ

### エンティティコンポーネントシステム（ECS）
- **Entity**: ID、型、コンテナを持つ基本オブジェクト
- **Component**: Transform、Velocity等の再利用可能な機能単位
- **System**: EntityManager、RenderSystem、PhysicsSystem等の処理系

### 主要システム
- **EntityManager**: エンティティの生成・管理・削除
- **RenderSystem**: PixiJSを使った描画処理
- **PhysicsSystem**: 移動・衝突判定等の物理演算
- **InputSystem**: マウス・キーボード入力の統合管理

## 実装済み機能

### 🏗️ ゲームシステム
- **多様タワーシステム**: 5種類の戦略的タワータイプ
- **高度ターゲティング**: 7種類の標的選択戦略
- **アップグレードシステム**: レベルアップによる性能強化
- **敵システム**: パス追従・ヘルス管理
- **ミサイルシステム**: 追跡・爆発・範囲ダメージ
- **衝突判定**: ミサイル-敵の当たり判定
- **ゲーム状態管理**: スコア・資金・ウェーブ管理

### ⚡ パフォーマンス最適化システム
- **オブジェクトプール**: ガベージコレクション完全回避システム
- **ミサイルプール**: 最大3000発の効率的管理
- **空間分割衝突判定**: SpatialHashによる効率的な衝突判定（80%+の計算量削減）
- **描画バッチング**: Graphics→Sprite変換による描画高速化
- **自動描画最適化**: エンティティ数50個超過で自動発動
- **リアルタイムFPS監視**: 平均・現在・履歴の包括的パフォーマンス監視
- **メモリ使用量追跡**: JSヒープサイズのリアルタイム監視
- **メモリ最適化**: 再利用可能エンティティ設計
- **パフォーマンステスト**: 大量ミサイル負荷試験機能
- **リアルタイムベンチマーク**: 空間分割の効果をリアルタイム測定

### 🏰 多様タワーシステム（NEW!）
**5種類の戦略的タワータイプ**
- **🏢 ベーシックタワー**: バランス重視（25ダメージ・2発/秒・150射程）
- **🔥 ラピッドタワー**: 高速連射（15ダメージ・6発/秒・120射程）
- **💣 ヘビータワー**: 大火力（80ダメージ・0.8発/秒・180射程）
- **🎯 スナイパータワー**: 超長射程（100ダメージ・1発/秒・300射程）
- **💥 スプラッシュタワー**: 範囲攻撃（40ダメージ・1.5発/秒・140射程）

**高度ターゲティング戦略（7種類）**
- **Nearest**: 最も近い敵を優先
- **Farthest**: 最も遠い敵を優先
- **Strongest**: 最もHPが高い敵を優先
- **Weakest**: 最もHPが低い敵を優先
- **Center**: 最も多くの敵に囲まれた敵を優先（スプラッシュ用）
- **First/Last**: パスの先頭/最後尾の敵を優先

**アップグレードシステム**
- **3段階レベルアップ**: 各タワーは最大レベル3まで強化可能
- **性能向上**: ダメージ・射程・連射速度が同時強化
- **コスト計算**: レベルに応じた建設・アップグレード費用
- **売却システム**: 建設費の70%で売却可能

**統計・効率追跡システム**
- **総ダメージ量**: タワーが与えた累計ダメージ
- **撃破数**: タワーがキルした敵の数
- **発射数**: タワーが発射したミサイル総数
- **命中効率**: (撃破数/発射数) × 100の効率計算
- **経験値システム**: ダメージ・キルに応じた経験値蓄積

**視覚差別化システム**
- **色分けデザイン**: タワータイプごとの識別可能な配色
- **サイズ差別化**: 火力に応じたベース・砲台・砲身サイズ
- **装飾システム**: 照準器・十字マークによる視覚的差別化

### 🎆 視覚エフェクトシステム
- **パーティクルエンジン**: 高性能な火花・爆発・煙エフェクト
- **ミサイル爆発**: 迫力ある多層パーティクル爆発
- **ヒットスパーク**: 敵への命中時の火花エフェクト
- **衝撃波エフェクト**: 範囲ダメージの視覚的表現
- **ミサイルトレイル**: ミサイルの軌跡エフェクト
- **最大1000パーティクル**: 大量エフェクトの同時処理

### 🎯 デバッグ&監視システム
- **リアルタイムデバッグGUI**: プロフェッショナルなダークテーマUI
- **パフォーマンス監視**: FPS・エンティティ数・ミサイル数の可視化
- **プール統計表示**: 使用率・アクティブ数のリアルタイム表示
- **ワンクリックテスト**: GUIからの簡単ミサイル負荷テスト
- **システム制御**: プール機能の動的切り替え

### 🎮 現在のゲームプレイ
- **5種類のタワーが戦略的配置**: 各タワーが異なる戦術で敵を狙い撃ち
- **多様な攻撃パターン**: 連射・重砲・狙撃・範囲攻撃の組み合わせ
- **高度なターゲティング**: タワータイプに応じた最適な標的選択
- **リアルタイム統計追跡**: 各タワーの効率・撃破数・ダメージ量を監視
- **インタラクティブタワー管理**: クリック選択・詳細情報表示・アップグレード・売却
- **視覚的フィードバック**: 選択ハイライト・射程表示・アップグレードエフェクト
- **戦略的アップグレード**: レベル3まで強化・性能向上・コスト計算
- **ウェーブベース敵出現**: 段階的難易度調整による戦略的ゲームプレイ
- **5種類敵タイプシステム**: 各敵が独自の特性・耐性・特殊能力を保有
- **ボスウェーブ**: 5ウェーブごとに強力なボス敵が出現
- **準備期間**: 各ウェーブ間の10秒間で戦略を立案
- **リアルタイムUI**: ウェーブ進行・敵情報・次ウェーブプレビューの完全可視化
- ミサイルが敵を追跡して爆発
- **1000発同時ミサイル処理**対応完了
- **空間分割による高速衝突判定**で80%+の最適化達成
- **描画バッチング**による視覚的パフォーマンス向上
- **迫力のパーティクルエフェクト**でミサイル爆発が視覚的に楽しめる

### 🎯 リアルタイムデバッグGUI（NEW!）
**画面右上のプロフェッショナルなデバッグパネル**
- **アクセス**: `Ctrl+D` でパネル表示/非表示切り替え
- **📊ボタン**: パネル展開/折りたたみ
- **美しいダークテーマ**: アニメーション付きモダンデザイン

#### ⚡ パフォーマンス監視
- **FPS表示**: リアルタイムフレームレート（色分け表示）
- **エンティティ数**: 総エンティティ数の監視
- **ミサイル数**: アクティブミサイル数のトラッキング

#### 🔧 オブジェクトプール統計
- **使用率**: プール使用率のリアルタイム表示
- **アクティブ/総数**: 詳細なプール状況
- **プログレスバー**: 視覚的使用率表示（色分け：緑→黄→赤）

#### ✨ 衝突判定最適化（NEW!）
- **チェック数**: 実行された衝突判定回数
- **スキップ数**: 空間分割により省略された判定回数
- **改善率**: パフォーマンス改善率（通常80%+）
- **空間分割**: グリッドベースの高速衝突判定

#### 🚀 ミサイルテスト機能
- **単発テスト**: 1発のミサイル発射テスト
- **大量発射(100発)**: 100発ミサイル同時発射
- **ミサイル嵐(10秒)**: 10秒間連続大量発射
- **カスタムテスト**: 任意数のミサイル発射（1-2000発対応）

#### 🎮 ゲーム制御
- **プール切替**: オブジェクトプーリング有効/無効の切り替え
- **統計表示**: 詳細プール統計をコンソール出力
- **ログクリア**: コンソールログのクリア

#### ⚡ パフォーマンスベンチマーク
- **衝突判定ベンチマーク**: 500発ミサイルで空間分割の効果を測定
- **衝突統計表示**: 詳細な衝突判定統計をコンソール出力
- **カスタムベンチマーク**: 任意数のミサイルでパフォーマンステスト（100-2000発）
- **リアルタイム改善率**: 空間分割による計算量削減効果の可視化

#### 🎆 パーティクルエフェクト
- **爆発テスト**: 10個の大規模爆発エフェクトを一斉発生
- **パーティクルクリア**: 全パーティクルを瞬時にクリア
- **アクティブ数表示**: リアルタイムパーティクル数の監視
- **使用率表示**: パーティクルシステムの負荷状況

#### 🌊 ウェーブシステム（NEW!）
- **リアルタイム進行監視**: 現在ウェーブ・敵出現数・撃破数・状態表示
- **カウントダウンタイマー**: 次ウェーブまでの正確な秒数カウント
- **進行度バー**: ウェーブ完了率の視覚的プログレス表示
- **次ウェーブプレビュー**: 出現予定敵タイプ・総数・ボスウェーブ判定・報酬情報
- **ウェーブ制御**: 次ウェーブ強制開始・詳細情報表示
- **敵タイプテスト**: 5種類敵タイプの個別出現テスト
  - **👹 ベーシック敵テスト**: 標準バランス型敵の生成
  - **💨 高速敵テスト**: 高機動力敵の生成
  - **🛡️ 重装敵テスト**: 高耐久・低速敵の生成
  - **🔰 装甲敵テスト**: 高防御・回復能力敵の生成
  - **👑 ボス敵テスト**: 最強ボス敵の生成

#### 🚀 パフォーマンス最適化（NEW!）
- **バッチ最適化有効/無効**: Graphics→Sprite変換の手動制御
- **パフォーマンス報告**: 詳細なFPS・メモリ・描画統計
- **レンダリングベンチマーク**: 10秒間の包括的パフォーマンステスト
- **自動最適化**: エンティティ50個超過で自動Graphics→Sprite変換

#### 🏗️ タワーシステムテスト（NEW!）
- **個別タワー配置**: 5種類タワーをランダム位置に配置
  - **🏢 ベーシック配置**: バランス型タワーをテスト
  - **🔥 ラピッド配置**: 高速連射タワーをテスト
  - **💣 ヘビー配置**: 大火力タワーをテスト
  - **🎯 スナイパー配置**: 超長射程タワーをテスト
  - **💥 スプラッシュ配置**: 範囲攻撃タワーをテスト
- **タワー統計**: 全タワーの詳細パフォーマンス統計をコンソール出力
  - レベル・撃破数・発射数・ダメージ量・命中効率を表示

#### 📋 システム情報
- **プール状態**: 有効/無効状況の表示
- **最後の操作**: 実行したコマンドの履歴（タイムスタンプ付き）

### 🧪 コンソールコマンド
```javascript
// ブラウザコンソールで実行可能（GUIからも操作可能）
game.testMassiveMissileBarrage(1000)     // 1000発一斉発射
game.testContinuousMissileStorm(100, 30) // 毎秒100発・30秒間
game.showPoolStats()                     // プール統計表示
game.togglePooling()                     // プール機能切り替え
game.forceCreateMissile()                // 単発ミサイル生成

// パフォーマンスベンチマーク
game.benchmarkCollisionSystem(500)      // 空間分割の効果をベンチマーク
game.showCollisionStats()               // 詳細衝突判定統計表示

// NEW! パフォーマンス最適化
game.enableBatchOptimization()          // 描画バッチ最適化有効化
game.disableBatchOptimization()         // 描画バッチ最適化無効化
game.showPerformanceReport()            // 詳細パフォーマンス報告
game.benchmarkRendering(10)             // 10秒間のレンダリングベンチマーク

// NEW! タワーシステム
game.getGameSystem().createTower(x, y, 'basic')    // ベーシックタワー配置
game.getGameSystem().createTower(x, y, 'rapid')    // ラピッドタワー配置
game.getGameSystem().createTower(x, y, 'heavy')    // ヘビータワー配置
game.getGameSystem().createTower(x, y, 'sniper')   // スナイパータワー配置
game.getGameSystem().createTower(x, y, 'splash')   // スプラッシュタワー配置

// パーティクルエフェクト
game.testParticleEffects()               // 爆発エフェクトシーケンステスト
game.getGameSystem().getParticleSystem().clear()  // 全パーティクルクリア

// NEW! ウェーブシステム
game.getCurrentWave()                    // 現在のウェーブ番号取得
game.getWaveProgress()                   // ウェーブ進行状況取得
game.forceStartNextWave()                // 次ウェーブを強制開始
game.showWaveInfo()                      // 詳細なウェーブ情報表示
game.testSpecificEnemyType('basic')     // 特定敵タイプのテスト生成
game.testSpecificEnemyType('fast')      // 高速敵のテスト生成
game.testSpecificEnemyType('heavy')     // 重装敵のテスト生成
game.testSpecificEnemyType('armored')   // 装甲敵のテスト生成
game.testSpecificEnemyType('boss')      // ボス敵のテスト生成
```

### 🚀 実装完了項目
- ✅ **空間分割衝突判定**（80%+の計算量削減）- **完了！**
- ✅ **パーティクルエフェクトシステム**（1000パーティクル対応）- **完了！**
- ✅ **描画バッチング**（Graphics→Sprite自動最適化）- **完了！**
- ✅ **複数タワータイプシステム**（5種類・7戦略・統計追跡）- **完了！**
- ✅ **ウェーブシステム**（段階的難易度・5敵タイプ・ボスウェーブ）- **完了！**
- ✅ **ウェーブシステムUI**（進行表示・プレビュー・制御）- **完了！**
- ✅ **タワーアップグレードUIシステム**（選択・情報表示・操作）- **完了！**

### 🌊 ウェーブシステム（NEW! - 完全実装済み）
**包括的なウェーブ進行管理システム**
- **段階的難易度調整**: ウェーブごとに15%ずつ難易度上昇・最大30体まで増加
- **5種類敵タイプシステム**: basic/fast/heavy/armored/boss（耐性・特殊能力付き）
- **ボスウェーブシステム**: 5ウェーブごとに強力なボス敵が出現
- **準備期間システム**: 各ウェーブ間に10秒の戦略立案時間
- **報酬システム**: ウェーブクリア時の資金・経験値報酬
- **敵スポーンキュー**: タイミング制御された敵の段階的出現

**ウェーブシステムUI（NEW! - 完全実装済み）**
- **リアルタイム進行表示**: 現在ウェーブ・敵出現数・撃破数の詳細監視
- **ウェーブ状態表示**: 準備中/進行中/完了の視覚的ステータス表示
- **次ウェーブプレビュー**: 出現予定の敵タイプ・総数・ボスウェーブ判定
- **カウントダウンタイマー**: 次ウェーブまでの正確な秒数表示
- **進行度バー**: ウェーブ完了率の視覚的プログレスバー
- **敵タイプテスト**: 各敵タイプの個別出現テスト機能
- **ウェーブ強制開始**: 準備時間をスキップして即座にウェーブ開始

**敵タイプシステム（詳細）**
- **👹 ベーシック兵**: HP100・速度50・標準的バランス型
- **💨 スピード兵**: HP60・速度90・高機動力・三角形
- **🛡️ ヘビー兵**: HP300・速度25・ミサイル耐性20%・正方形
- **🔰 アーマー兵**: HP200・速度40・ミサイル耐性40%・シールド50・回復2/秒
- **👑 ボス**: HP1000・速度30・多重耐性・シールド200・回復5/秒

**ウェーブパターンシステム**
- **序盤ウェーブ**: basic70%/fast30%の構成
- **中盤ウェーブ**: basic40%/fast40%/heavy20%の構成  
- **後半ウェーブ**: fast30%/heavy40%/armored30%の構成
- **ボスウェーブ**: basic40%/armored40%/boss20%の構成

### 🏗️ タワーアップグレードUIシステム（NEW! - 完全実装済み）
**包括的なタワー管理・アップグレード機能**
- **タワー選択システム**: クリック検出・視覚的ハイライト表示・パルス＆回転アニメーション
- **射程範囲表示**: 選択タワーの射程円表示・半透明オーバーレイ
- **アップグレードパネル**: 画面下部のモダンなダークテーマUI
- **詳細情報表示**: 現在の性能・戦績・統計の完全可視化
- **アップグレード予览**: 次レベルの能力変化・コスト表示
- **ワンクリック操作**: アップグレード・売却ボタン・資金チェック
- **視覚エフェクト**: アップグレード時のキラキラエフェクト・売却時の金貨エフェクト
- **経済システム統合**: 資金管理・コスト計算・収支バランス

**タワー選択システム（詳細）**
- **インテリジェントクリック検出**: 30ピクセル半径の正確なクリック判定
- **多層ハイライト表示**: 外側円（緑）・内側円・射程範囲の同時表示
- **動的アニメーション**: パルス効果（スケール変化）・回転エフェクト
- **自動選択解除**: 他タワークリック・空白エリアクリックで解除

**アップグレード情報パネル（詳細）**
- **📊 現在の性能**: ダメージ・射程・攻撃速度・レベル表示
- **📈 戦績統計**: 撃破数・総ダメージ・命中率・発射数の詳細追跡
- **⬆️ アップグレード予览**: 能力向上値・次レベル性能・必要コスト
- **💰 経済情報**: アップグレードコスト・売却価値・資金チェック
- **🏆 最大レベル表示**: レベル上限到達時の特別メッセージ

**視覚的フィードバック（詳細）**
- **⬆️ アップグレードエフェクト**: 上向きキラキラ・多色パーティクル・放射状輝き
- **💸 売却エフェクト**: 金貨舞い散り・煙エフェクト・重力落下アニメーション
- **リアルタイム更新**: 1秒間隔での統計自動更新
- **状態依存色分け**: 資金不足時の無効化・ボタン状態変化

### 🚀 次の開発課題
- 💰 **経済システム拡張**: より複雑な収支バランス・特殊通貨
- 🗺️ **マップシステム**: 複数ステージ・パス設計ツール

## 技術的な決定事項

- **TypeScript**: 型安全性とコード品質向上のため
- **PixiJS**: 高パフォーマンスな2Dレンダリングのため
- **Vite**: 高速な開発サーバーとビルドツール
- **ECS**: 大量オブジェクト管理の効率化
- **ミサイル大量発射**: ゲームの特徴として多数のミサイルを同時に処理する必要がある
